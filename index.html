<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Blockchain Fake Product Checker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/web3@1.7.4/dist/web3.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 30px auto;
      padding: 20px;
      background: #f3f6fa;
    }
    h1 {
      text-align: center;
    }
    label, input, button {
      display: block;
      margin-top: 8px;
      width: 100%;
      box-sizing: border-box;
    }
    input, button {
      padding: 10px;
      font-size: 1rem;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    button {
      background: #1877f2;
      border: none;
      color: white;
      cursor: pointer;
      font-weight: bold;
    }
    button:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
    #qr-reader {
      margin: 18px 0;
      width: 100%;
      max-width: 300px;
      margin-left: auto;
      margin-right: auto;
    }
    .success {
      background: #e8ffe7;
      color: #12821e;
      padding: 11px;
      border-radius: 5px;
      margin-top: 10px;
    }
    .error {
      background: #ffefef;
      color: #ba273a;
      padding: 11px;
      border-radius: 5px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>Blockchain Fake Product Checker</h1>
  <button id="connectBtn">Connect Wallet</button>
  <p id="walletAddress"></p>

  <h3>Register New Product (Admin Only)</h3>
  <form id="regForm">
    <label>Product ID</label>
    <input type="text" id="pid" required />
    <label>Product Name</label>
    <input type="text" id="pname" required />
    <label>Manufacturer</label>
    <input type="text" id="manuf" required />
    <label>Manufacture Date</label>
    <input type="date" id="mfgdate" required />
    <button type="submit">Register Product</button>
  </form>
  <div id="regResult"></div>

  <hr />

  <h3>Verify Product (Scan or Enter ID)</h3>
  <div id="qr-reader"></div>
  <input type="text" id="vpid" placeholder="Product ID" />
  <button id="verifyBtn" disabled>Verify</button>
  <div id="verifyResult"></div>

  <script>
    // Contract ABI and address - replace with your deployed contract values
    const contractABI = [
      {
        "inputs":[
          {"internalType":"string","name":"productId","type":"string"},
          {"internalType":"string","name":"productName","type":"string"},
          {"internalType":"string","name":"manufacturer","type":"string"},
          {"internalType":"uint256","name":"mfgDate","type":"uint256"}
        ],
        "name":"registerProduct",
        "outputs":[],
        "stateMutability":"nonpayable",
        "type":"function"
      },
      {
        "inputs":[{"internalType":"string","name":"productId","type":"string"}],
        "name":"verifyProduct",
        "outputs":[
          {"internalType":"bool","name":"exists","type":"bool"},
          {"internalType":"string","name":"name","type":"string"},
          {"internalType":"string","name":"manufacturer","type":"string"},
          {"internalType":"uint256","name":"manufactureDate","type":"uint256"}
        ],
        "stateMutability":"view",
        "type":"function"
      }
    ];

    const contractAddress = "YOUR_DEPLOYED_CONTRACT_ADDRESS"; // <-- Set this after deployment

    let web3, contract, userAccount;

    document.getElementById('connectBtn').onclick = async () => {
      if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        try {
          await ethereum.request({ method: 'eth_requestAccounts' });
          const accounts = await web3.eth.getAccounts();
          userAccount = accounts[0];
          document.getElementById("walletAddress").textContent = "Connected: " + userAccount;
          contract = new web3.eth.Contract(contractABI, contractAddress);
          document.getElementById('verifyBtn').disabled = false;
        } catch (err) {
          alert("Wallet connection denied.");
        }
      } else {
        alert("Please install MetaMask extension!");
      }
    };

    document.getElementById('regForm').onsubmit = async (e) => {
      e.preventDefault();
      if (!contract || !userAccount) return alert("Connect wallet first.");
      const pid = document.getElementById('pid').value.trim();
      const pname = document.getElementById('pname').value.trim();
      const manuf = document.getElementById('manuf').value.trim();
      const mfgDateStr = document.getElementById('mfgdate').value;
      if (!mfgDateStr) return alert("Please enter manufacture date.");
      const mfgDate = Math.floor(new Date(mfgDateStr).getTime() / 1000);

      const div = document.getElementById('regResult');
      div.textContent = '';
      div.className = '';

      try {
        await contract.methods.registerProduct(pid, pname, manuf, mfgDate).send({ from: userAccount });
        div.textContent = "✅ Product registered successfully!";
        div.className = "success";
        e.target.reset();
      } catch (error) {
        div.textContent = "❌ Registration failed. Only contract owner can register products.";
        div.className = "error";
      }
    };

    // Initialize QR code scanner
    const scanner = new Html5Qrcode("qr-reader");

    Html5Qrcode.getCameras().then(devices => {
      if (devices && devices.length) {
        scanner.start(
          { deviceId: { exact: devices[0].id } },
          { fps: 10, qrbox: 250 },
          decodedText => {
            document.getElementById('vpid').value = decodedText;
          },
          errorMessage => {
            // Ignore scan errors for better UX
          }
        ).catch(err => {
          document.getElementById('verifyResult').textContent = "❌ Unable to start camera or QR scanner.";
          document.getElementById('verifyResult').className = "error";
        });
      } else {
        document.getElementById('verifyResult').textContent = "❌ No camera found!";
        document.getElementById('verifyResult').className = "error";
      }
    });

    document.getElementById('verifyBtn').onclick = async () => {
      if (!contract) return alert("Connect wallet first.");
      const pid = document.getElementById('vpid').value.trim();
      const div = document.getElementById('verifyResult');
      div.textContent = '';
      div.className = '';

      if (!pid) {
        div.textContent = "❌ Please enter or scan a Product ID.";
        div.className = "error";
        return;
      }

      try {
        const res = await contract.methods.verifyProduct(pid).call();
        if (res[0]) {
          const date = new Date(res[3] * 1000);
          div.innerHTML = `✅ <strong>Product is Authentic</strong><br>
                          Name: <b>${res[1]}</b><br>
                          Manufacturer: <b>${res[2]}</b><br>
                          Manufacture Date: <b>${date.toLocaleDateString()}</b>`;
          div.className = "success";
        } else {
          div.textContent = "❌ Product not found on blockchain (may be fake).";
          div.className = "error";
        }
      } catch (err) {
        div.textContent = "❌ Error verifying product on blockchain.";
        div.className = "error";
      }
    };
  </script>
</body>
</html>
