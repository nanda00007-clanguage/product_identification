<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Secure Product Registry Demo</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/web3@1.7.4/dist/web3.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
body {
  background: linear-gradient(135deg,#e3ecfb 0%,#d5e7e0 100%);
  font-family: 'Montserrat', Arial, sans-serif;
  margin:0; min-height:100vh;
}
.mainbox {
  max-width: 430px;
  margin: 44px auto 0 auto;
  background: white;
  border-radius: 18px;
  box-shadow: 0 8px 40px #b6c1de33;
  padding: 32px 26px 32px 26px;
}
h1 {
  font-weight:800;
  font-size:2.1rem;
  margin:0 0 10px 0;
  color:#1a50b4;
  letter-spacing:1px;
  text-align:center;
}
.step {
  margin-top: 20px;
  padding: 19px 10px 11px 10px;
  border-radius: 14px;
  background: #f9fafb;
  box-shadow: 0 2px 10px #f8f7f7;
}
label { margin:14px 0 3px 3px; font-weight:600;}
input, button, textarea {
  width:100%;font-size:1.04rem; padding:10px 14px; margin:7px 0 13px 0;
  border-radius:7px; border:1.2px solid #cbdbef;
  background:#f6f8fc; font-family:inherit; box-sizing:border-box;
  transition:.16s border;
}
input:focus, textarea:focus { border-color:#2475f5;background:#eaf1fe;}
button { background:linear-gradient(91deg,#2061e2 70%,#1c5fab); color:white; border:none; cursor:pointer; font-weight:800;}
button:disabled {background:#a8c3e6;}
.success { color:#097700; background:#e3fae6; border:1.2px solid #38da57; }
.error { color:#d6342c; background:#fcf0f1; border:1.2px solid #ef6c60;}
.status { padding: 10px; border-radius:7px; margin:-7px 0 8px 0; font-weight:600;}
.hide { display:none!important; }
hr {margin:29px 0;}
#qr-reader { margin:0 auto 11px auto; width:100%; max-width:285px; border-radius:16px; border:1.5px solid #e5ebfa;}
.flex { display:flex; gap:10px; align-items:center;}
@media (max-width:500px) {.mainbox{padding:9px 2vw;}}
</style>
</head>
<body>
<div class="mainbox">
  <h1>Product Registry</h1>

  <!-- Step 1: Login -->
  <div class="step" id="loginStep">
    <label>Username</label>
    <input id="loginUser" autocomplete="username"/>
    <label>Password</label>
    <input id="loginPwd" type="password" autocomplete="current-password"/>
    <button id="loginBtn">Login</button>
    <div id="loginMsg" class="status hide"></div>
  </div>

  <!-- Step 2: Wallet -->
  <div class="step hide" id="walletStep">
    <button id="connectBtn">🔗 Connect MetaMask Wallet</button>
    <span id="walletDisp" style="margin-left:7px; color:#1b795b; font-weight:600;"></span>
    <div id="walletMsg" class="status hide"></div>
  </div>

  <!-- Step 3: OTP for product registration -->
  <div class="step hide" id="otpStep">
    <label>Registration OTP (get from admin)</label>
    <input id="userOtp"/>
    <button id="otpBtn" disabled>Verify OTP → unlock registration</button>
    <div id="otpMsg" class="status hide"></div>
  </div>

  <!-- Step 4: Product Registration (after OTP) -->
  <div class="step hide" id="regStep">
    <form id="registerForm" autocomplete="off">
      <h3 style="margin:0 0 4px 0;font-size:1.15rem;font-weight:800;color:#2c4977">Register Product</h3>
      <label>Product ID</label><input id="pid" required />
      <label>Name</label><input id="pname" required />
      <label>Manufacturer</label><input id="manuf" required />
      <label>Manufacture Date</label><input id="mfgdate" type="date" required />
      <button type="submit">Register</button>
    </form>
    <div id="regMsg" class="status hide"></div>
  </div>

  <hr/>

  <!-- Step 5: Verification & Delivery/Fraud -->
  <div class="step hide" id="mainDapp">
    <h3 style="margin-top:0;font-size:1.08rem;color:#2955ae;font-weight:700;">Verify Product</h3>
    <div id="qr-reader"></div>
    <input id="verifyId" placeholder="Enter or scan Product ID"/>
    <button id="verifyBtn" disabled>Verify</button>
    <div id="verifyMsg" class="status hide"></div>
    <div class="flex hide" id="otpActions">
      <button id="genDelOtpBtn" style="background:#fee073;color:#664800;">Generate Delivery OTP</button>
      <button id="confDelBtn" style="background:#97efd2;color:#186c49;">Confirm Delivery (Buyer)</button>
    </div>
    <button id="fraudBtn" class="hide" style="background:#fbe9e9;color:#8d2529; margin-top:7px;">Report Fraud</button>
    <textarea id="fraudDetails" class="hide" rows="2" placeholder="Describe fraud/problem"></textarea>
    <div id="fraudMsg" class="status hide"></div>
  </div>
</div>

<script>
// CONTRACT ABI/ADDRESS -------------------------
const contractABI = [
  {inputs:[{type:"address",name:"user"},{type:"bytes32",name:"otpHash"}],name:"generateRegistrationOtp",outputs:[],stateMutability:"nonpayable",type:"function"},
  {inputs:[{type:"string",name:"otp"}],name:"verifyUserOtp",outputs:[],stateMutability:"nonpayable",type:"function"},
  {inputs:[{type:"string",name:"productId"},{type:"string",name:"productName"},{type:"string",name:"manufacturer"},{type:"uint256",name:"mfgDate"}],name:"registerProduct",outputs:[],stateMutability:"nonpayable",type:"function"},
  {inputs:[{type:"string",name:"productId"}],name:"verifyProduct",outputs:[
    {type:"bool",name:"exists"},{type:"string",name:"name"},
    {type:"string",name:"manufacturer"},{type:"uint256",name:"manufactureDate"},
    {type:"bool",name:"delivered"},{type:"address",name:"recipient"}],stateMutability:"view",type:"function"},
  {inputs:[{type:"string",name:"productId"},{type:"address",name:"recipient"},{type:"bytes32",name:"otpHash"}],name:"generateDeliveryOtp",outputs:[],stateMutability:"nonpayable",type:"function"},
  {inputs:[{type:"string",name:"productId"},{type:"string",name:"otp"}],name:"confirmDelivery",outputs:[],stateMutability:"nonpayable",type:"function"},
  {inputs:[{type:"string",name:"productId"},{type:"string",name:"details"}],name:"reportFraud",outputs:[],stateMutability:"nonpayable",type:"function"}
];
const contractAddress = "YOUR_CONTRACT_ADDRESS"; // <-- UPDATE THIS!

let web3, contract, userAccount, otpVerified = false;

// --- Login
document.getElementById("loginBtn").onclick = function() {
  if(document.getElementById("loginUser").value === "user"
     && document.getElementById("loginPwd").value === "password123") {
    document.getElementById("loginStep").classList.add("hide");
    document.getElementById("walletStep").classList.remove("hide");
  } else {
    let m=document.getElementById("loginMsg"); m.textContent="Invalid username or password."; m.className="status error"; m.classList.remove("hide");
  }
};
// --- Wallet Connect
document.getElementById("connectBtn").onclick = async () => {
  if(!window.ethereum) return alert("Please install MetaMask");
  web3 = new Web3(window.ethereum);
  try {
    let a = await ethereum.request({ method: "eth_requestAccounts" });
    userAccount = a[0];
    contract = new web3.eth.Contract(contractABI, contractAddress);
    document.getElementById("walletDisp").textContent = "Connected: "+userAccount.slice(0,6)+"..."+userAccount.slice(-4);
    document.getElementById("walletStep").classList.add("hide");
    document.getElementById("otpStep").classList.remove("hide");
  }catch(e) { alert("Wallet connection denied."); }
};
// --- OTP logic
document.getElementById("userOtp").oninput = function(){
  document.getElementById("otpBtn").disabled = this.value.trim().length === 0;
  document.getElementById("otpMsg").classList.add("hide");
};
document.getElementById("otpBtn").onclick = async function() {
  const otp = document.getElementById("userOtp").value.trim();
  let m = document.getElementById("otpMsg");
  m.classList.add("hide");
  try {
    await contract.methods.verifyUserOtp(otp).send({from:userAccount});
    document.getElementById("otpStep").classList.add("hide");
    document.getElementById("regStep").classList.remove("hide");
    document.getElementById("mainDapp").classList.remove("hide");
    otpVerified = true;
    m.textContent="OTP verified!";
    m.classList.remove("hide"); m.classList.remove("error"); m.classList.add("success");
  }catch(e){
    m.textContent = "Invalid OTP, or admin has not generated for you.";
    m.classList.remove("hide","success"); m.classList.add("error");
  }
};
// --- Register Product
document.getElementById("registerForm").onsubmit = async function(e){
  e.preventDefault();
  if(!otpVerified) return alert("Complete OTP verification first.");
  const pid=document.getElementById("pid").value.trim();
  const pname=document.getElementById("pname").value.trim();
  const manuf=document.getElementById("manuf").value.trim();
  const mfgdate=Math.floor(new Date(document.getElementById("mfgdate").value).getTime()/1000);
  let regMsg = document.getElementById("regMsg");
  try{
    await contract.methods.registerProduct(pid,pname,manuf,mfgdate).send({from:userAccount});
    regMsg.textContent="Product registered!";
    regMsg.classList.remove("hide","error"); regMsg.classList.add("success");
    this.reset();
  }catch(e){
    regMsg.textContent="Registration failed (are you verified & contract owner?).";
    regMsg.classList.remove("hide","success"); regMsg.classList.add("error");
  }
};
// --- Product Verification and Delivery/Fraud
Html5Qrcode.getCameras().then(devs=>{
  if(devs&&devs.length){
    let qr=new Html5Qrcode("qr-reader");
    qr.start({deviceId:{exact:devs[0].id}}, {fps:10,qrbox:220}, decoded=>{
      document.getElementById("verifyId").value=decoded;
      document.getElementById("verifyBtn").disabled=false;
    },err=>{});
  }
});
document.getElementById("verifyId").oninput=function() {
  document.getElementById("verifyBtn").disabled = this.value.trim()==="";
};
document.getElementById("verifyBtn").onclick = async function() {
  let pid=document.getElementById("verifyId").value.trim();
  let msg=document.getElementById("verifyMsg");
  try{
    let r=await contract.methods.verifyProduct(pid).call();
    if(r.exists){
      let dt=new Date(r.manufactureDate*1000);
      let status=r.delivered?"✅ Delivered":"⏳ Not Delivered";
      msg.innerHTML=`✅ <b>Product Found</b><br>Name:<b>${r.name}</b><br>Manufacturer:<b>${r.manufacturer}</b><br>Manufacture Date:<b>${dt.toLocaleDateString()}</b><br>Status:<b>${status}</b>`;
      msg.classList.remove("hide","error"); msg.classList.add("success");
      document.getElementById("otpActions").classList.remove("hide");
      document.getElementById("fraudBtn").classList.remove("hide");
      document.getElementById("fraudDetails").classList.remove("hide");
    }else{
      msg.textContent="Product not found.";
      msg.classList.remove("hide","success"); msg.classList.add("error");
    }
  }catch(e){
    msg.textContent="Error verifying.";
    msg.classList.remove("hide","success"); msg.classList.add("error");
  }
};
// --- Delivery OTP generation (Admin)
document.getElementById("genDelOtpBtn").onclick = async function() {
  let pid=document.getElementById("verifyId").value.trim();
  let recipient=prompt("Enter recipient wallet address:");
  if(!recipient) return;
  let otp=String(Math.floor(Math.random()*900000+100000));
  let otpHash=web3.utils.keccak256(otp);
  try{
    await contract.methods.generateDeliveryOtp(pid,recipient,otpHash).send({from:userAccount});
    alert(`OTP for delivery: ${otp}\nShare with recipient only.`);
  }catch(e){ alert("Failed. Only contract owner can assign OTP."); }
};
// --- Confirm Delivery (Buyer)
document.getElementById("confDelBtn").onclick = async function() {
  let pid=document.getElementById("verifyId").value.trim();
  let otp=prompt("Enter delivery OTP:");
  if(!otp) return;
  try{
    await contract.methods.confirmDelivery(pid,otp).send({from:userAccount});
    alert("Delivery confirmed!");
  }catch(e){ alert("Failed: Invalid OTP, not recipient, or already confirmed."); }
};
// --- Fraud Reporting
document.getElementById("fraudBtn").onclick = async function() {
  let pid=document.getElementById("verifyId").value.trim();
  let details=document.getElementById("fraudDetails").value.trim();
  let msg=document.getElementById("fraudMsg");
  if(!pid||!details){msg.textContent="Product ID & details required.";msg.classList.remove("hide","success");msg.classList.add("error");msg.style.display="block";return;}
  try{
    await contract.methods.reportFraud(pid,details).send({from:userAccount});
    msg.textContent="Fraud reported!";
    msg.classList.remove("hide","error");msg.classList.add("success");
  }catch(e){
    msg.textContent="Failed to report fraud.";
    msg.classList.remove("hide","success");msg.classList.add("error");
  }
};
</script>
</body>
</html>
