<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Product Authentication DApp</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet" />
<style>
  body {
    font-family: 'Montserrat', sans-serif;
    background: linear-gradient(90deg, #e3f2fd 0%, #bbdefb 100%);
    margin: 0; min-height: 100vh;
    display: flex; justify-content: center; align-items: start;
    padding: 40px 15px;
  }
  .container {
    background: white;
    border-radius: 18px;
    box-shadow: 0 8px 28px -4px rgba(33, 149, 242, 0.33);
    max-width: 450px;
    width: 100%;
    padding: 36px 30px 40px 30px;
  }
  h1 {
    font-weight: 700;
    font-size: 2rem;
    margin-bottom: 28px;
    color: #1565c0;
    text-align: center;
  }
  label {
    font-weight: 600;
    margin-top: 18px;
    display: block;
    color: #0d47a1;
  }
  input, textarea, button {
    width: 100%;
    font-size: 1rem;
    padding: 12px 14px;
    margin-top: 6px;
    border: 2px solid #90caf9;
    border-radius: 10px;
    box-sizing: border-box;
    font-family: 'Montserrat', sans-serif;
    outline-offset: 3px;
    transition: border-color 0.3s ease;
  }
  input:focus, textarea:focus {
    border-color: #1976d2;
    box-shadow: 0 0 6px #82b1ffaa;
  }
  textarea {
    resize: vertical;
    min-height: 68px;
  }
  button {
    background: #1976d2;
    border: none;
    color: white;
    font-weight: 700;
    cursor: pointer;
    border-radius: 10px;
    margin-top: 22px;
    transition: background-color 0.3s ease;
  }
  button:disabled {
    background: #bbdefb;
    cursor: not-allowed;
  }
  .status-message {
    margin-top: 14px;
    padding: 12px 16px;
    border-radius: 8px;
    font-weight: 600;
    display: none;
  }
  .success {
    background-color: #e8f5e9;
    color: #2e7d32;
    border: 2px solid #43a047;
  }
  .error {
    background-color: #ffebee;
    color: #c62828;
    border: 2px solid #e53935;
  }
  .hidden {
    display: none !important;
  }
  #qr-reader {
    margin-top: 20px;
    border-radius: 14px;
    overflow: hidden;
  }
  .actions-row {
    display: flex;
    gap: 14px;
    margin-top: 18px;
    justify-content: space-between;
  }
  .link-button {
    cursor: pointer;
    color: #1565c0;
    font-weight: 600;
    text-decoration: underline;
    user-select: none;
    border: none;
    background: transparent;
    font-size: 0.9rem;
    padding: 0;
    margin-top: 10px;
  }
</style>
</head>
<body>
<div class="container" role="main" aria-label="Product Authentication App">

  <!-- Login Step -->
  <section id="login-section" aria-live="polite">
    <h1>User Login</h1>
    <label for="login-username">Username</label>
    <input id="login-username" autocomplete="username" aria-required="true" />
    <label for="login-password">Password</label>
    <input id="login-password" type="password" autocomplete="current-password" aria-required="true" />
    <button id="login-btn" aria-disabled="false">Login</button>
    <div id="login-message" class="status-message" role="alert" aria-live="assertive"></div>
  </section>

  <!-- Wallet Connect Step -->
  <section id="wallet-section" class="hidden" aria-live="polite">
    <h1>Connect Wallet</h1>
    <button id="wallet-connect-btn" aria-disabled="false">Connect MetaMask Wallet</button>
    <p id="wallet-address" aria-label="Connected wallet address" aria-live="polite" style="margin-top:14px; font-weight:600; color:#2e7d32;"></p>
    <div id="wallet-message" class="status-message" role="alert" aria-live="assertive"></div>
  </section>

  <!-- OTP Verification Step -->
  <section id="otp-section" class="hidden" aria-live="polite">
    <h1>OTP Verification - Registration Access</h1>
    <label for="otp-input">Enter OTP from Admin</label>
    <input id="otp-input" autocomplete="off" aria-required="true" placeholder="Enter registration OTP" />
    <button id="otp-verify-btn" disabled aria-disabled="true">Verify OTP</button>
    <div id="otp-message" class="status-message" role="alert" aria-live="assertive"></div>
  </section>

  <!-- Product Registration -->
  <section id="registration-section" class="hidden" aria-live="polite">
    <h1>Register Product</h1>
    <form id="product-registration-form" autocomplete="off">
      <label for="product-id">Product ID</label>
      <input id="product-id" required placeholder="Unique product identifier" aria-required="true" />
      <label for="product-name">Product Name</label>
      <input id="product-name" required aria-required="true" />
      <label for="product-manufacturer">Manufacturer</label>
      <input id="product-manufacturer" required aria-required="true" />
      <label for="product-date">Manufacture Date</label>
      <input id="product-date" type="date" required aria-required="true" />
      <button type="submit" aria-label="Submit new product">Register Product</button>
      <div id="registration-message" class="status-message" role="alert" aria-live="assertive"></div>
    </form>
  </section>

  <!-- Product Verification & Actions -->
  <section id="verification-section" class="hidden" aria-live="polite">
    <h1>Verify Product</h1>
    <div id="qr-reader" aria-label="QR code scanner"></div>
    <label for="verify-input">Enter or scan Product ID</label>
    <input id="verify-input" autocomplete="off" aria-required="true" placeholder="Product ID" />
    <button id="verify-btn" disabled aria-disabled="true">Verify Product</button>
    <div id="verify-message" class="status-message" role="alert" aria-live="assertive"></div>

    <div class="actions-row hidden" id="actions-row">
      <button id="generate-otp-btn" aria-label="Generate delivery OTP" aria-disabled="true">Generate Delivery OTP</button>
      <button id="confirm-otp-btn" aria-label="Confirm delivery OTP" aria-disabled="true">Confirm Delivery OTP</button>
    </div>

    <section aria-label="Report fraudulent product" style="margin-top: 18px;">
      <h2>Report Fraud</h2>
      <label for="fraud-product-id">Product ID to Report</label>
      <input id="fraud-product-id" placeholder="Product ID" autocomplete="off" />
      <label for="fraud-details">Details</label>
      <textarea id="fraud-details" placeholder="Describe the fraud or issue"></textarea>
      <button id="report-fraud-btn" disabled aria-disabled="true">Submit Fraud Report</button>
      <div id="fraud-message" class="status-message" role="alert" aria-live="assertive"></div>
    </section>
  </section>
</div>

<script>
(async () => {
  // Contract ABI and address (replace YOUR_CONTRACT_ADDRESS)
  const contractABI = [
    {"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"bytes32","name":"otpHash","type":"bytes32"}],"name":"generateRegistrationOtp","outputs":[],"stateMutability":"nonpayable","type":"function"},
    {"inputs":[{"internalType":"string","name":"otp","type":"string"}],"name":"verifyUser","outputs":[],"stateMutability":"nonpayable","type":"function"},
    {"inputs":[{"internalType":"string","name":"productId","type":"string"},{"internalType":"string","name":"productName","type":"string"},{"internalType":"string","name":"manufacturer","type":"string"},{"internalType":"uint256","name":"mfgDate","type":"uint256"}],"name":"registerProduct","outputs":[],"stateMutability":"nonpayable","type":"function"},
    {"inputs":[{"internalType":"string","name":"productId","type":"string"}],"name":"verifyProduct","outputs":[{"internalType":"bool","name":"exists","type":"bool"},{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"manufacturer","type":"string"},{"internalType":"uint256","name":"manufactureDate","type":"uint256"},{"internalType":"bool","name":"delivered","type":"bool"},{"internalType":"address","name":"recipient","type":"address"}],"stateMutability":"view","type":"function"},
    {"inputs":[{"internalType":"string","name":"productId","type":"string"},{"internalType":"address","name":"recipient","type":"address"},{"internalType":"bytes32","name":"otpHash","type":"bytes32"}],"name":"generateDeliveryOtp","outputs":[],"stateMutability":"nonpayable","type":"function"},
    {"inputs":[{"internalType":"string","name":"productId","type":"string"},{"internalType":"string","name":"otp","type":"string"}],"name":"confirmDelivery","outputs":[],"stateMutability":"nonpayable","type":"function"},
    {"inputs":[{"internalType":"string","name":"productId","type":"string"},{"internalType":"string","name":"details","type":"string"}],"name":"reportFraud","outputs":[],"stateMutability":"nonpayable","type":"function"}
  ];
  const contractAddress = "YOUR_CONTRACT_ADDRESS";

  // Elements
  const loginSection = document.getElementById('login-section');
  const loginUsername = document.getElementById('login-username');
  const loginPassword = document.getElementById('login-password');
  const loginBtn = document.getElementById('login-btn');
  const loginMessage = document.getElementById('login-message');

  const walletSection = document.getElementById('wallet-section');
  const walletConnectBtn = document.getElementById('wallet-connect-btn');
  const walletAddressDisplay = document.getElementById('wallet-address');
  const walletMessage = document.getElementById('wallet-message');

  const otpSection = document.getElementById('otp-section');
  const otpInput = document.getElementById('otp-input');
  const otpVerifyBtn = document.getElementById('otp-verify-btn');
  const otpMessage = document.getElementById('otp-message');

  const registrationSection = document.getElementById('registration-section');
  const productRegistrationForm = document.getElementById('product-registration-form');
  const registrationMessage = document.getElementById('registration-message');

  const verificationSection = document.getElementById('verification-section');
  const qrReader = document.getElementById('qr-reader');
  const verificationInput = document.getElementById('verify-input');
  const verificationBtn = document.getElementById('verify-btn');
  const verificationMessage = document.getElementById('verify-message');

  const actionsRow = document.getElementById('actions-row');
  const generateOtpBtn = document.getElementById('generate-otp-btn');
  const confirmOtpBtn = document.getElementById('confirm-otp-btn');

  const reportFraudBtn = document.getElementById('report-fraud-btn');
  const fraudProductIdInput = document.getElementById('fraud-product-id');
  const fraudDetailsInput = document.getElementById('fraud-details');
  const fraudMessage = document.getElementById('fraud-message');

  let web3, contract, userAccount;
  let otpVerified = false;

  // Login Handler
  loginBtn.addEventListener('click', () => {
    if(loginUsername.value === 'user' && loginPassword.value === 'password123') {
      loginMessage.style.display = 'none';
      loginSection.style.display = 'none';
      walletSection.style.display = 'block';
    } else {
      loginMessage.textContent = 'Invalid username or password.';
      loginMessage.style.display = 'block';
    }
  });

  // Wallet Connect Handler
  walletConnectBtn.addEventListener('click', async () => {
    if(!window.ethereum) {
      alert('Please install MetaMask');
      return;
    }
    try {
      web3 = new Web3(window.ethereum);
      await ethereum.request({ method: 'eth_requestAccounts' });
      userAccount = (await web3.eth.getAccounts())[0];
      walletAddressDisplay.textContent = userAccount;
      contract = new web3.eth.Contract(contractABI, contractAddress);

      walletSection.style.display = 'none';
      otpSection.style.display = 'block';
      otpVerifyBtn.disabled = true;
    } catch (e) {
      walletMessage.textContent = 'Wallet connection denied.';
      walletMessage.style.display = 'block';
    }
  });

  // Enable OTP Verify button on input
  otpInput.addEventListener('input', () => {
    otpVerifyBtn.disabled = otpInput.value.trim() === '';
    otpMessage.style.display = 'none';
  });

  // OTP Verify Handler
  otpVerifyBtn.addEventListener('click', async () => {
    try {
      otpMessage.style.display = 'block';
      otpMessage.textContent = 'Verifying OTP...';
      await contract.methods.verifyUser(otpInput.value.trim()).send({from: userAccount});
      otpMessage.textContent = 'OTP verified successfully!';
      otpMessage.className = 'status-message success';
      otpSection.style.display = 'none';
      registrationSection.style.display = 'block';
      verificationSection.style.display = 'block';
      otpVerified = true;
      verificationBtn.disabled = true;
      generateOtpBtn.disabled = true;
      confirmOtpBtn.disabled = true;
      reportFraudBtn.disabled = true;
    } catch {
      otpMessage.textContent = 'Invalid OTP or not issued for your address.';
      otpMessage.className = 'status-message error';
    }
  });

  // Product Registration Handler
  productRegistrationForm.addEventListener('submit', async (event) => {
    event.preventDefault();
    if(!otpVerified) {
      alert('Please verify OTP first');
      return;
    }
    registrationMessage.style.display = 'block';
    registrationMessage.textContent = 'Registering product...';
    const productId = document.getElementById('product-id').value.trim();
    const productName = document.getElementById('product-name').value.trim();
    const manufacturer = document.getElementById('product-manufacturer').value.trim();
    const dateStr = document.getElementById('product-date').value;
    const manufactureDate = Math.floor(new Date(dateStr).getTime() / 1000);

    try {
      await contract.methods.registerProduct(productId, productName, manufacturer, manufactureDate)
          .send({from: userAccount});
      registrationMessage.textContent = 'Product registered successfully!';
      registrationMessage.className = 'status-message success';
      productRegistrationForm.reset();
    } catch {
      registrationMessage.textContent = 'Registration failed. Are you the owner with permission?';
      registrationMessage.className = 'status-message error';
    }
  });

  // Setup QR code scanner
  try {
    const cameras = await Html5Qrcode.getCameras();
    if(cameras && cameras.length) {
      const qrScanner = new Html5Qrcode('qr-reader');
      qrScanner.start(
        {deviceId: {exact: cameras[0].id}},
        {fps: 10, qrbox: 250},
        decodedText => {
          verificationInput.value = decodedText;
          verificationBtn.disabled = false;
        },
        errorMessage => {
          // ignore scan errors to keep smooth UX
        }
      );
    }
  } catch {}

  verificationInput.addEventListener('input', () => {
    verificationBtn.disabled = verificationInput.value.trim() === '';
  });

  // Verify Product Handler
  verificationBtn.addEventListener('click', async () => {
    const id = verificationInput.value.trim();
    verificationMessage.style.display = 'block';
    verificationMessage.textContent = 'Verifying product...';

    try {
      const res = await contract.methods.verifyProduct(id).call();
      if(res.exists) {
        const date = new Date(res.manufactureDate * 1000);
        const deliveryStatus = res.delivered ? '✅ Delivered' : '❌ Not Delivered';
        verificationMessage.innerHTML = `
          <strong>Product Found:</strong><br />
          Name: ${res.name}<br />
          Manufacturer: ${res.manufacturer}<br />
          Manufacture Date: ${date.toLocaleDateString()}<br />
          Delivery Status: ${deliveryStatus}
        `;
        verificationMessage.className = 'status-message success';
        actionsRow.classList.remove('hidden');
        generateOtpBtn.disabled = false;
        confirmOtpBtn.disabled = false;
        reportFraudBtn.disabled = false;
      } else {
        verificationMessage.textContent = 'Product not found.';
        verificationMessage.className = 'status-message error';
        actionsRow.classList.add('hidden');
        generateOtpBtn.disabled = true;
        confirmOtpBtn.disabled = true;
        reportFraudBtn.disabled = true;
      }
    } catch {
      verificationMessage.textContent = 'Verification error.';
      verificationMessage.className = 'status-message error';
    }
  });

  // Generate Delivery OTP (Admin)
  generateOtpBtn.addEventListener('click', async () => {
    const id = verificationInput.value.trim();
    if(!id) return alert('Verify a product first');
    const recipient = prompt('Enter recipient wallet address:');
    if(!recipient) return;
    const otp = Math.floor(100000 + Math.random() * 900000).toString();
    const otpHash = web3.utils.keccak256(otp);
    try {
      await contract.methods.generateDeliveryOtp(id, recipient, otpHash).send({from: userAccount});
      alert(`Delivery OTP: ${otp}\nGive this ONLY to the recipient.`);
    } catch {
      alert('Failed to generate delivery OTP. Are you admin?');
    }
  });

  // Confirm Delivery OTP (Buyer)
  confirmOtpBtn.addEventListener('click', async () => {
    const id = verificationInput.value.trim();
    if(!id) return alert('Verify a product first');
    const otp = prompt('Enter OTP received on delivery:');
    if(!otp) return;
    try {
      await contract.methods.confirmDelivery(id, otp).send({from: userAccount});
      alert('Delivery confirmed!');
    } catch {
      alert('Failed to confirm delivery. Invalid OTP or you are not authorized.');
    }
  });

  // Fraud Report Handler
  reportFraudBtn.addEventListener('click', async () => {
    const id = verificationInput.value.trim();
    const details = fraudDetailsInput.value.trim();
    fraudMessage.style.display = 'block';
    if(!id || !details) {
      fraudMessage.textContent = 'Please enter product ID and details.';
      fraudMessage.className = 'status-message error';
      return;
    }
    try {
      await contract.methods.reportFraud(id, details).send({from: userAccount});
      fraudMessage.textContent = 'Fraud reported successfully!';
      fraudMessage.className = 'status-message success';
      fraudDetailsInput.value = '';
    } catch {
      fraudMessage.textContent = 'Failed to report fraud.';
      fraudMessage.className = 'status-message error';
    }
  });
})();
</script>
</body>
</html>
